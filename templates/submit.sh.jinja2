#!/bin/bash

{% if settings.is_pikcluster: -%}
#SBATCH --qos=short
#SBATCH --time=0-23:50:00
#SBATCH --job-name={{settings.experiment}}
#SBATCH --account=ice
#SBATCH --output=./slurm_out.out
#SBATCH --error=./slurm_error.err
#SBATCH --ntasks=160
#SBATCH --mail-type=END,FAIL
#SBATCH --mail-user=mengel@pik-potsdam.de
{% if settings.pik_partition=="broadwell" -%}
#SBATCH --tasks-per-node=32
#SBATCH --partition=broadwell
module purge
module load pism/stable1.0_broadwell
{% else %}
#SBATCH --tasks-per-node=16
module purge
module load pism/stable08_srunpetsc
{% endif %}

runname=`echo $PWD | awk -F/ '{print $NF}'`
outdir={{settings.working_dir}}/$runname

mkdir -p $outdir/log/

# make the PISM execution script aware that it is on compute nodes.
export PISM_ON_CLUSTER=1
./pism_run.sh $SLURM_NTASKS > $outdir/log/pism.out

{% else %}

#@ job_name = smuc_$(cluster)_$(stepid)
#@ class = micro
#@ group = pr94ga
#@ notify_user = mengel@pik-potsdam.de
#@ job_type = MPICH
#@ output = ./loadl.out
#@ error  = ./loadl.err
#@ wall_clock_limit = 47:59:00
#@ notification=always
#@ network.MPI = sn_all,not_shared,us
#@ node = 12
#@ tasks_per_node = 28
#@ island_count = 1
#@ energy_policy_tag = albrecht_pism_2015
#@ minimize_time_to_solution = yes
#@ queue

. /etc/profile
. /etc/profile.d/modules.sh

#setup of environment
module unload mpi.ibm intel mkl netcdf
module load mkl/11.3 intel/16.0 mpi.intel
module load netcdf/mpi/4.3  ## or module load netcdf/mpi/4.4
module load gcc/6
module load gsl/2.3
module load hdf5/mpi
module load fftw/mpi/3.3

export PETSC_DIR=/home/hpc/pr94ga/di36lav/petsc/petsc-3.7.6-mpicc
export PETSC_ARCH=arch-linux2-c-debug

# get user and computer specific variables like paths
runname=`echo $PWD | awk -F/ '{print $NF}'`
outdir={{settings.working_dir}}/$runname

echo $LOADL_STEP_ID
echo $HOME
echo $LOADL_PROCESSOR_LIST
echo $LOADL_TOTAL_TASKS
echo $outdir

number_of_cores=`echo $LOADL_PROCESSOR_LIST | wc -w`
echo $number_of_cores

mkdir -p $outdir/log/

export PISM_ON_CLUSTER=1
#run_smoothing_nomass.sh $LOADL_TOTAL_TASKS > $outdir/log/smoothing_nomass.out
pism_run.sh $LOADL_TOTAL_TASKS >> $outdir/log/pism.out
{% endif %}

